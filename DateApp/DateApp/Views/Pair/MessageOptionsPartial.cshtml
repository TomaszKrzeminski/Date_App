@model MessageOptionsViewModel


<style type="text/css">

    .hidden {
        display: none;
    }
</style>



<div class="row">
    <div style="min-height:1900px;border-style:solid;" class="col-lg-6">
        <div class="row">
            <div class="col-lg-12" style="min-height:100px;border-style:solid;background-color:#fd267d;">
                <div class="row">
                    <div class="col-lg-4" style="max-height:80px;max-width:80px;">
                        <a href='@Url.Action("Panel","Home")'>
                            <img alt="0" class="img-thumbnail" src=@Model.UserMainPhotoPath>
                        </a>
                    </div>
                    <div class="col-lg-8"> <label>@Model.UserName</label></div>
                </div>

            </div>


        </div>
        <div class="row">
            <form id="PairPanelForm" asp-action="PairPanel" asp-controller="Pair" method="get">
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-dark" name="Pair">Pary</button>
                    <button type="button" class="btn btn-dark" name="Message">Wiadomości</button>
                    <input class="hidden" name="select" id="SelectP" />
                </div>
            </form>
        </div>


        <div id="ChatUsers">
            @foreach (var item in Model.list)
            {

                if (item.IsRead == false)
                {
                    <div class="row">

                        <div class="col-lg-12">

                            <form class="ChooseReceiver" asp-action="WriteMessage" asp-controller="Message" method="post">
                                <div>
                                    <label class="font-weight-bold">@item.Name</label>
                                </div>
                                <img style="border: 3px solid #000; padding:0;" alt=@item.Name class="" src=@item.ReceiverMainPhotoPath width="100" height="100">
                                <p class="font-weight-bold">@item.MessageBeggining</p>
                                <input type="hidden" value="@item.ReceiverId" name="ReceiverId" />
                            </form>
                            <hr />
                        </div>
                    </div>


                }
                else
                {

                    <div class="row">

                        <div class="col-lg-12">

                            <form class="ChooseReceiver" asp-action="WriteMessage" asp-controller="Message" method="post">
                                <div>
                                    <label>@item.Name</label>
                                </div>
                                <img border="0" style="border-style:outset" alt=@item.Name class="" src=@item.ReceiverMainPhotoPath width="100" height="100">
                                <p>@item.MessageBeggining</p>
                                <input type="hidden" value="@item.ReceiverId" name="ReceiverId" />
                            </form>
                            <hr />
                        </div>
                    </div>


                }



            }
        </div>




    </div>
    <div class="col-lg-6"></div>
</div>

<script>

    ///change View from Message to Pair

    $("button[name='Pair']").click(function () {
        $('#SelectP').val("Pair");
        $('#PairPanelForm').submit();
    });

    $("button[name='Message']").click(function () {
        $('#SelectP').val("Message");
        $('#PairPanelForm').submit();
    });

    /////







    /////Send Message

    $(document).on('click', '#SendMessage', function () {

        var message = {};
        var ReceiverId = $('#RId').val();
        var SenderId = $('#SId').val();
        var Text = $('#MText').val();
        message['ReceiverId'] = ReceiverId;
        message['SenderId'] = SenderId;
        message['MessageText'] = Text;


        $.ajax({
     url: '@Url.Action("SendMessage", "Message")',
     type: "post",
     contentType: 'application/x-www-form-urlencoded',
     data: message,
     headers: {
         RequestVerificationToken:
             $('input:hidden[name="__RequestVerificationToken"]').val()
     },
            success: function (result) {

         $("#MessageWritePage").html(result);


     }
 });


    });

    ////





    /////Select Page

     $(document).on('click', '.page-link', function () {


         var element = $(this).text();
         var ActionMade;
         var ReceiverId = $('#ReceiverIdChangePage').val();
         if (element == "Next")
         {
             ActionMade = "Next";
         }
         else if (element == "Previous")
         {
             ActionMade = "Previous";
         }
         else
         {
             ActionMade = element;
         }


         var ActivePage = $("li.active a").text();

        var Data = {};
        Data['ReceiverId'] = ReceiverId;
         Data['ActionMade'] = ActionMade;
         Data['ActivePage'] = ActivePage;


        $.ajax({
     url: '@Url.Action("SelectPage", "Message")',
     type: "get",
     contentType: 'application/x-www-form-urlencoded',
     data: Data,
     headers: {
         RequestVerificationToken:
             $('input:hidden[name="__RequestVerificationToken"]').val()
     },
            success: function (result) {


         $("#MessageWritePage").html(result);


     }
 });


    });
   ////

    ///// //////

    ///Write Message
    $(document).on('click', 'form.ChooseReceiver', function () {

        var data = {};
        var Id = $(this).find('input[name="ReceiverId"]').val();
        data["ReceiverId"] = Id;


        $.ajax({
     url: '@Url.Action("WriteMessage", "Message")',
     type: "post",
     contentType: 'application/x-www-form-urlencoded',
     data: data,
     headers: {
         RequestVerificationToken:
             $('input:hidden[name="__RequestVerificationToken"]').val()
     },
            success: function (result) {
                

         $("#MessageWritePage").html(result);


     }
 });


    });

    ///


    //// refresh receivers
    $(document).on('click', 'form.ChooseReceiver', function () {


        //// fire after few seconds wait for db to update
        window.setTimeout(function () {

var data = {};
        var Id = $(this).find('input[name="ReceiverId"]').val();
        data["ReceiverId"] = Id;


        $.ajax({
     url: '@Url.Action("RefreshReceivers", "Message")',
     type: "post",
     contentType: 'application/x-www-form-urlencoded',
     data: data,
     headers: {
         RequestVerificationToken:
             $('input:hidden[name="__RequestVerificationToken"]').val()
     },
            success: function (result) {

                


                $("#ChatUsers").html(result);


     }
 });

        }, 3000);





    });

    ///

    ////Signal R


    var connection = new signalR.HubConnectionBuilder().withUrl("/messages").build();



   


    connection.on("UpdateChat_Users", function (message) {   

        
               
var data = {};
        var Id = $(this).find('input[name="ReceiverId"]').val();
        data["ReceiverId"] = Id;


        $.ajax({
     url: '@Url.Action("RefreshReceivers", "Message")',
     type: "post",
     contentType: 'application/x-www-form-urlencoded',
     data: data,
     headers: {
         RequestVerificationToken:
             $('input:hidden[name="__RequestVerificationToken"]').val()
     },
            success: function (result) {

               


                $("#ChatUsers").html(result);


     }
 });



    });

   

   



    connection.start().then( 

    ).catch(function (err) {
        alert("Błąd  w Refresh Users"+ err);

    }).then(() => {

       
    });










    //////


    ////Signal R refresch writeMessage




     var connection2 = new signalR.HubConnectionBuilder().withUrl("/messages").build();


   


    connection2.on("UpdateChat_WriteMessage", function (Id) {   

        alert("Signal R  with Id" + Id);

        var ReceiverName = $("#ReceiverName").val();

        if (ReceiverName != null && ReceiverName == Id)
        {


            alert("Signal R  Refresh Write Message");
               
 var data = {};

            data["ReceiverId"] = ReceiverName;


        $.ajax({
     url: '@Url.Action("WriteMessage", "Message")',
     type: "post",
     contentType: 'application/x-www-form-urlencoded',
     data: data,
     headers: {
         RequestVerificationToken:
             $('input:hidden[name="__RequestVerificationToken"]').val()
     },
            success: function (result) {
                alert("Write Message from Signal R refresh Users");

         $("#MessageWritePage").html(result);


     }
 });


        }


        



    });

   

   



    connection2.start().then( 

    ).catch(function (err) {
        alert("Błąd w Chat");

    }).then(() => {

       
    });
























    /////


</script>